!!! Abstract 大家好~我是`米洛`！<br/>
> 我正在从0到1打造一个开源的接口测试平台, 也在编写一套与之对应的`教程`，希望大家多多支持。<br/>
> 欢迎关注我的公众号`米洛的测开日记`，一起交流学习! 

### 回顾

  上一节我们`优化了`返回值相关的内容，今天我们就顺藤摸瓜，以一个产品经理的角色，来找找自己的问题。
  
  其实很多时候都是当局者迷，所以如果各位有兴趣，也可以参与到`需求收集`的过程中来。这里感谢大家提出的一些建议，我都有记录。
  
![](https://files.mdnice.com/user/11504/0f3f2c60-3dfa-4663-8b7a-b4749d46a2f1.png)

  可以看到，需求还是挺多的。由于都是私下抽时间来写，所以效率比较低。今天我们就来完成这个小功能点: 测试报告跳转到对应的case。
  
### 历史原因

  在做之前，我们先捋一捋如今的情况。我们的用例是有一个唯一的id的，但由于`历史原因`，当初设计的时候在用例的url加上了用例目录id（这个是借鉴的yapi）。
  
  之所以人家这么做，是为了能在url里面直接快速找到对应的目录，并且他们的目录需要支持`url访问`。但我们如今是不能做到这个效果的，举个例子:
  
![](https://files.mdnice.com/user/11504/8c16f23a-c3ee-42d6-9bad-e08c573e4332.png)

  不管我们如何`切换`左侧的目录，url都不会变化，但yapi是支持的，它切换目录的时候，对应的url也会发生变化。
  
  我们再来看看我们的用例的url:
  
![](https://files.mdnice.com/user/11504/1d078730-ff3f-46c7-8018-2723660c0e72.png)

  目前是根据目录id/用例id来确定数据的，但由于我们`测试报告`里头只存储了`用例id`，并没有存储目录id，所以导致我们暂时无法跳转到具体的用例页面:
  
![](https://files.mdnice.com/user/11504/eed0bfbd-e689-4276-902b-e2cff07ab63a.png)

  这就很尴尬了，思考了一段时间以后，我本来打算`去掉`url里面的目录id，但我又发现，新增测试用例时，它归属于`哪个`目录，我是记录在url里面的，所以这就很尴尬了。那就暂时不去吧，我们换个思路，获取测试报告数据的时候，我们把用例目录`一并`查出来。
  
### 修改报告查询方法

![](https://files.mdnice.com/user/11504/a798cd07-83a4-4360-b1a9-d97ed1356e58.png)

  修改报告查询方法，注意，这里使用了join查询，将TestCase的directory_id也查了出来，由于sqlalchemy的join结果是分开的，不是在一个model对象里面，我们来看看.all()返回了什么。
  
![](https://files.mdnice.com/user/11504/e32ace0c-a8df-4691-8715-ce171e696a6c.png)

  可以看出的是，它是一个`元祖`，也就是这样的数据:
  
```
[(PityTestResult, directory_id)]
```
  
  所以我们才需要把它遍历并拆开，但是由于TestResult里面又没有directory_id字段，那该咋整呢？所以我们还需要修改下这个model:
  
![](https://files.mdnice.com/user/11504/3c230f56-add2-46e0-823d-e7d16154e06f.png)

  我们在PityTestResult对象里面多加一个`directory_id`字段，只要不是Column类型的，对数据库就不会有影响，也就是说数据库不会映射这个`字段`。
  
  最后我们把查出来的directory_id重新赋予这个对象即可。
  
---

  来看看结果:
  
![](https://files.mdnice.com/user/11504/2924dcf7-e5c5-4f72-b5e9-f000dbface7f.png)

  可以看到里面已经有directory_id了，说明查询成了，接着我们就去修改前端代码。
  
### 修改前端代码

![](https://files.mdnice.com/user/11504/10d17baa-91c8-48a8-a040-27b940f7dadd.png)

  看看效果:
  
![](https://files.mdnice.com/user/11504/7aab942a-b136-42d8-8d2a-dfb7088abea5.gif)

  今天的内容比较简短，主要是因为博主最近核酸抽了不少，下次补多一点。也希望大家多多参与pity的讨论之中呀~
  
  
  